{"version":3,"sources":["assets\\sprite\\joystick\\Joystick.js"],"names":["cc","Class","Component","properties","dot","type","Node","displayName","tooltip","ring","joystickType","JoystickEnum","JoystickType","FIXED","directionType","DirectionType","ALL","_stickPos","_touchLocation","onLoad","_radius","width","_initTouchEvent","FOLLOW","node","opacity","onEnable","JoystickEvent","getInstance","on","JoystickEventType","CHANGE_JOYSTICK_TYPE","_onChangeJoystickType","onDisable","off","EventType","TOUCH_START","_touchStartEvent","TOUCH_MOVE","_touchMoveEvent","TOUCH_END","_touchEndEvent","TOUCH_CANCEL","event","emit","touchPos","convertToNodeSpaceAR","getLocation","getPosition","distance","sub","mag","setPosition","posX","x","posY","y","p","v2","normalize","speedType","SpeedType","NORMAL","FAST","moveDistance","STOP"],"mappings":"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","sourceRoot":"/","sourcesContent":["import JoystickEnum from 'JoystickEnum';\nimport JoystickEvent from 'JoystickEvent';\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        dot: {\n            default: null,\n            type: cc.Node,\n            displayName: 'Dot',\n            tooltip: '摇杆操纵点',\n        },\n        ring: {\n            default: null,\n            type: cc.Node,\n            displayName: 'Ring',\n            tooltip: '摇杆背景节点',\n        },\n\n        joystickType: {\n            default: JoystickEnum.JoystickType.FIXED,\n            type: JoystickEnum.JoystickType,\n            displayName: 'Touch Type',\n            tooltip: '触摸类型',\n        },\n\n        directionType: {\n            default: JoystickEnum.DirectionType.ALL,\n            type: JoystickEnum.DirectionType,\n            displayName: 'Direction Type',\n            tooltip: '方向类型',\n        },\n\n        _stickPos: {\n            default: null,\n            type: cc.Node,\n            tooltip: '摇杆所在位置',\n        },\n        _touchLocation: {\n            default: null,\n            type: cc.Node,\n            tooltip: '触摸位置',\n        },\n    },\n\n    onLoad() {\n        this._radius = this.ring.width / 2;\n        this._initTouchEvent();\n        // hide joystick when follow\n        if (this.joystickType === JoystickEnum.JoystickType.FOLLOW) {\n            this.node.opacity = 0;\n        }\n    },\n\n    onEnable() {\n        JoystickEvent.getInstance().on(JoystickEnum.JoystickEventType.CHANGE_JOYSTICK_TYPE, this._onChangeJoystickType, this);\n    },\n\n    onDisable() {\n        JoystickEvent.getInstance().off(JoystickEnum.JoystickEventType.CHANGE_JOYSTICK_TYPE, this._onChangeJoystickType, this);\n    },\n\n    _onChangeJoystickType(type) {\n        this.joystickType = type;\n        this.node.opacity = type === JoystickEnum.JoystickType.FIXED ? 255 : 0;\n    },\n\n    _initTouchEvent() {\n        // set the size of joystick node to control scale\n        this.node.on(cc.Node.EventType.TOUCH_START, this._touchStartEvent, this);\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, this._touchMoveEvent, this);\n        this.node.on(cc.Node.EventType.TOUCH_END, this._touchEndEvent, this);\n        this.node.on(cc.Node.EventType.TOUCH_CANCEL, this._touchEndEvent, this);\n    },\n\n    _touchStartEvent(event) {\n        JoystickEvent.getInstance().emit(JoystickEnum.JoystickEventType.TOUCH_START, \"joystick touch start\", 10);\n        const touchPos = this.node.convertToNodeSpaceAR(event.getLocation());\n\n        if (this.joystickType === JoystickEnum.JoystickType.FIXED) {\n            this._stickPos = this.ring.getPosition();\n\n            // 触摸点与圆圈中心的距离\n            const distance = touchPos.sub(this.ring.getPosition()).mag();\n\n            // 手指在圆圈内触摸,控杆跟随触摸点\n            this._radius > distance && this.dot.setPosition(touchPos);\n\n        } else if (this.joystickType === JoystickEnum.JoystickType.FOLLOW) {\n\n            // 记录摇杆位置，给 touch move 使用\n            this._stickPos = touchPos;\n            this.node.opacity = 255;\n            this._touchLocation = event.getLocation();\n\n            // 更改摇杆的位置\n            this.ring.setPosition(touchPos);\n            this.dot.setPosition(touchPos);\n        }\n    },\n\n    _touchMoveEvent(event) {\n        // 如果 touch start 位置和 touch move 相同，禁止移动\n        if (this.joystickType === JoystickEnum.JoystickType.FOLLOW && this._touchLocation === event.getLocation()) {\n            return false;\n        }\n\n        // 以圆圈为锚点获取触摸坐标\n        const touchPos = this.ring.convertToNodeSpaceAR(event.getLocation());\n        const distance = touchPos.mag();\n\n        // 由于摇杆的 postion 是以父节点为锚点，所以定位要加上 touch start 时的位置\n        const posX = this._stickPos.x + touchPos.x;\n        const posY = this._stickPos.y + touchPos.y;\n\n        // 归一化\n        const p = cc.v2(posX, posY).sub(this.ring.getPosition()).normalize();\n\n        let speedType;\n\n        if (this._radius > distance) {\n            this.dot.setPosition(cc.v2(posX, posY));\n\n            speedType = JoystickEnum.SpeedType.NORMAL;\n        } else {\n            // 控杆永远保持在圈内，并在圈内跟随触摸更新角度\n            const x = this._stickPos.x + p.x * this._radius;\n            const y = this._stickPos.y + p.y * this._radius;\n            this.dot.setPosition(cc.v2(x, y));\n\n            speedType = JoystickEnum.SpeedType.FAST;\n        }\n\n        JoystickEvent.getInstance().emit(JoystickEnum.JoystickEventType.TOUCH_MOVE, event, {speedType: speedType, moveDistance: p});\n    },\n\n    _touchEndEvent(event) {\n        this.dot.setPosition(this.ring.getPosition());\n        if (this.joystickType === JoystickEnum.JoystickType.FOLLOW) {\n            this.node.opacity = 0;\n        }\n\n        JoystickEvent.getInstance().emit(JoystickEnum.JoystickEventType.TOUCH_END, event, {speedType: JoystickEnum.SpeedType.STOP});\n    },\n\n});\n"]}